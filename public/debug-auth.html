<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 5px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        pre { background: #111; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Auth Debug Tool</h1>

    <div class="section">
        <h2>Step 1: Check Session</h2>
        <button onclick="checkSession()">Check Session</button>
        <div id="session-output"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test Function Call</h2>
        <button onclick="testFunctionCall()">Test ai-dashboard-chat</button>
        <div id="function-output"></div>
    </div>

    <div class="section">
        <h2>Step 3: Test with Raw Fetch</h2>
        <button onclick="testRawFetch()">Test Raw Fetch</button>
        <div id="fetch-output"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        window.supabase = createClient(
            'https://bkbcqocpjahewqjmlgvf.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrYmNxb2NwamFoZXdxam1sZ3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MDcwOTgsImV4cCI6MjA2MjM4MzA5OH0.K00WoAEZNf93P-6r3dCwOZaYah51bYuBPwHtDdW82Ek'
        );

        window.checkSession = async function() {
            const output = document.getElementById('session-output');
            output.innerHTML = '<p>Checking session...</p>';

            try {
                const { data: { session }, error } = await window.supabase.auth.getSession();

                if (error) {
                    output.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                    return;
                }

                if (!session) {
                    output.innerHTML = `
                        <p class="error">‚ùå No active session found!</p>
                        <p>You need to log in first. Go to your app and log in, then come back to this page.</p>
                    `;
                    return;
                }

                output.innerHTML = `
                    <p class="success">‚úÖ Session found!</p>
                    <pre>
User ID: ${session.user.id}
Email: ${session.user.email}
Token (first 50 chars): ${session.access_token.substring(0, 50)}...
Token expires at: ${new Date(session.expires_at * 1000).toLocaleString()}
                    </pre>
                `;

                // Store for later use
                window.currentSession = session;
            } catch (error) {
                output.innerHTML = `<p class="error">‚ùå Exception: ${error.message}</p>`;
            }
        };

        window.testFunctionCall = async function() {
            const output = document.getElementById('function-output');
            output.innerHTML = '<p>Testing function call...</p>';

            if (!window.currentSession) {
                output.innerHTML = '<p class="warning">‚ö†Ô∏è  Please check session first!</p>';
                return;
            }

            try {
                const { data, error } = await window.supabase.functions.invoke('ai-dashboard-chat', {
                    body: {
                        action: 'list_sessions'
                    }
                });

                if (error) {
                    output.innerHTML = `
                        <p class="error">‚ùå Function Error</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                    return;
                }

                output.innerHTML = `
                    <p class="success">‚úÖ Function call successful!</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                output.innerHTML = `<p class="error">‚ùå Exception: ${error.message}</p>`;
            }
        };

        window.testRawFetch = async function() {
            const output = document.getElementById('fetch-output');
            output.innerHTML = '<p>Testing raw fetch...</p>';

            if (!window.currentSession) {
                output.innerHTML = '<p class="warning">‚ö†Ô∏è  Please check session first!</p>';
                return;
            }

            try {
                const response = await fetch('https://bkbcqocpjahewqjmlgvf.supabase.co/functions/v1/ai-dashboard-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.currentSession.access_token}`,
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrYmNxb2NwamFoZXdxam1sZ3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MDcwOTgsImV4cCI6MjA2MjM4MzA5OH0.K00WoAEZNf93P-6r3dCwOZaYah51bYuBPwHtDdW82Ek'
                    },
                    body: JSON.stringify({ action: 'list_sessions' })
                });

                const responseText = await response.text();

                let parsed;
                try {
                    parsed = JSON.parse(responseText);
                } catch (e) {
                    parsed = null;
                }

                if (response.ok) {
                    output.innerHTML = `
                        <p class="success">‚úÖ Status: ${response.status}</p>
                        <pre>${JSON.stringify(parsed || responseText, null, 2)}</pre>
                    `;
                } else {
                    output.innerHTML = `
                        <p class="error">‚ùå Status: ${response.status}</p>
                        <pre>${JSON.stringify(parsed || responseText, null, 2)}</pre>
                        <p class="warning">Check Supabase function logs at:</p>
                        <a href="https://supabase.com/dashboard/project/bkbcqocpjahewqjmlgvf/functions/ai-dashboard-chat/logs" target="_blank">
                            https://supabase.com/dashboard/project/bkbcqocpjahewqjmlgvf/functions/ai-dashboard-chat/logs
                        </a>
                    `;
                }
            } catch (error) {
                output.innerHTML = `<p class="error">‚ùå Exception: ${error.message}</p>`;
            }
        };

        // Auto-check session on load
        window.addEventListener('load', () => {
            setTimeout(() => window.checkSession(), 500);
        });
    </script>
</body>
</html>
